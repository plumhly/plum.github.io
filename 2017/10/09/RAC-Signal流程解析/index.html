<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> RAC Signal流程解析 · plum的技术博客</title><meta name="description" content="RAC Signal流程解析 - plum"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="plum的技术博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/plummit" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/plumhly" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">RAC Signal流程解析</h1><div class="post-info">2017年10月9日</div><div class="post-content"><h1 id="RAC-Signal流程解析"><a href="#RAC-Signal流程解析" class="headerlink" title="RAC Signal流程解析"></a>RAC Signal流程解析</h1><blockquote>
<p><strong>ReactiveCocoa</strong>是一个响应式的开源库，它把通知、代理、KVO等OC的技术整合在一起。这样写出的代码更简介，更优雅。尤其是如果你是用MVVM架构来开发的项目，有了它，你就能轻松并优雅的解决View和VeiwModel之间传值和更新的问题。</p>
</blockquote>
<h3 id="一-信号的创建"><a href="#一-信号的创建" class="headerlink" title="一. 信号的创建"></a>一. 信号的创建</h3><p>创建一个信号最基本的方法是用<code>createSignal:</code>方法：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signal = [RACSignal createSignal:^RACDisposable * _Nullable(<span class="keyword">id</span>&lt;RACSubscriber&gt;  _Nonnull subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:<span class="string">@"hello RAC"</span>];</span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p>我们来看看这个方法内部的实现。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (RACSignal *)createSignal:(RACDisposable * (^)(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber))didSubscribe &#123;</span><br><span class="line">	<span class="keyword">return</span> [RACDynamicSignal createSignal:didSubscribe];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>里面调用了<code>RACDynamicSignal</code>的<code>createSignal:</code>方法，进入里面，实现如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+ (RACSignal *)createSignal:(RACDisposable * (^)(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber))didSubscribe &#123;</span><br><span class="line">	RACDynamicSignal *signal = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">	signal-&gt;_didSubscribe = [didSubscribe <span class="keyword">copy</span>];<span class="comment">//这里会copy block</span></span><br><span class="line">	<span class="keyword">return</span> [signal setNameWithFormat:<span class="string">@"+createSignal:"</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里需要注意的是返回的<code>RACDynamicSignal</code>会持有<code>didSubscribe</code> block,所以这里要注意在创建RACSignal的时候，是否会引<code>起循环引用</code>。<br>创建的过程比较简单。下面看看信号的订阅。</p>
<h3 id="二-信号的订阅"><a href="#二-信号的订阅" class="headerlink" title="二. 信号的订阅"></a>二. 信号的订阅</h3><p>信号订阅会使用方法 <code>subscribeNext: error: completed:</code>，同时RAC也提供了这三个时间单独或者两两组合的方法，非常方便。使用如下:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[signal subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, x);</span><br><span class="line">&#125; error:^(<span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"error"</span>);</span><br><span class="line">&#125; completed:^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"completed"</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p>当对应的事件触发的时候，相应的block会调用。这个方法的实现如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (RACDisposable *)subscribeNext:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> x))nextBlock error:(<span class="keyword">void</span> (^)(<span class="built_in">NSError</span> *error))errorBlock completed:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))completedBlock &#123;</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(nextBlock != <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(errorBlock != <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(completedBlock != <span class="literal">NULL</span>);</span><br><span class="line">	</span><br><span class="line">	RACSubscriber *o = [RACSubscriber subscriberWithNext:nextBlock error:errorBlock completed:completedBlock];</span><br><span class="line">	<span class="keyword">return</span> [<span class="keyword">self</span> subscribe:o];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里面会生成<code>RACSubscriber</code>对象，<code>RACSubscriber</code>的创建方法内部实现是：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)subscriberWithNext:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> x))next error:(<span class="keyword">void</span> (^)(<span class="built_in">NSError</span> *error))error completed:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))completed &#123;</span><br><span class="line">	RACSubscriber *subscriber = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line"></span><br><span class="line">	subscriber-&gt;_next = [next <span class="keyword">copy</span>];</span><br><span class="line">	subscriber-&gt;_error = [error <span class="keyword">copy</span>];</span><br><span class="line">	subscriber-&gt;_completed = [completed <span class="keyword">copy</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> subscriber;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>它也会把所有的block参数copy。同时这个类还实现了RACSubscriber协议,这个协议里面有四个方法<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)sendNext:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value;	<span class="comment">//next事件</span></span><br><span class="line">- (<span class="keyword">void</span>)sendError:(<span class="keyword">nullable</span> <span class="built_in">NSError</span> *)error; <span class="comment">//错误事件</span></span><br><span class="line">- (<span class="keyword">void</span>)sendCompleted; <span class="comment">//完成事件</span></span><br><span class="line">- (<span class="keyword">void</span>)didSubscribeWithDisposable:(RACCompoundDisposable *)disposable;</span><br></pre></td></tr></table></figure></p>
<p>然后把<code>RACSubscriber</code>的对象作为参数，调用了<code>RACDynamicSignal</code>的 <code>subscribe:</code>方法，这个方法的实现：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (RACDisposable *)subscribe:(<span class="keyword">id</span>&lt;RACSubscriber&gt;)subscriber &#123;</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(subscriber != <span class="literal">nil</span>);</span><br><span class="line"></span><br><span class="line">	RACCompoundDisposable *disposable = [RACCompoundDisposable compoundDisposable];</span><br><span class="line">	subscriber = [[RACPassthroughSubscriber alloc] initWithSubscriber:subscriber signal:<span class="keyword">self</span> disposable:disposable];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">self</span>.didSubscribe != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		RACDisposable *schedulingDisposable = [RACScheduler.subscriptionScheduler schedule:^&#123;</span><br><span class="line">			RACDisposable *innerDisposable = <span class="keyword">self</span>.didSubscribe(subscriber);</span><br><span class="line">			[disposable addDisposable:innerDisposable];</span><br><span class="line">		&#125;];</span><br><span class="line"></span><br><span class="line">		[disposable addDisposable:schedulingDisposable];</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> disposable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法使用<code>RACSignal</code>、<code>subscriber</code>、<code>RACCompoundDisposable</code>创建了一个<code>RACPassthroughSubscriber</code>实例，创建方法实现如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithSubscriber:(<span class="keyword">id</span>&lt;RACSubscriber&gt;)subscriber signal:(RACSignal *)signal disposable:(RACCompoundDisposable *)disposable &#123;</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(subscriber != <span class="literal">nil</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line"></span><br><span class="line">	_innerSubscriber = subscriber;</span><br><span class="line">	_signal = signal;</span><br><span class="line">	_disposable = disposable;</span><br><span class="line"></span><br><span class="line">	[<span class="keyword">self</span>.innerSubscriber didSubscribeWithDisposable:<span class="keyword">self</span>.disposable];<span class="comment">//这里把disposable传递给subscriber，让整个清除处理操作连成一条线。</span></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这是一个简单的创建过程，唯一值得注意的是调用了<code>didSubscribeWithDisposable:</code>这个方法，在<code>RACSubscriber</code>里面这个方法的实现如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)didSubscribeWithDisposable:(RACCompoundDisposable *)otherDisposable &#123;</span><br><span class="line">	<span class="keyword">if</span> (otherDisposable.disposed) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	RACCompoundDisposable *selfDisposable = <span class="keyword">self</span>.disposable;</span><br><span class="line">	[selfDisposable addDisposable:otherDisposable];</span><br><span class="line"></span><br><span class="line">	@unsafeify(otherDisposable);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If this subscription terminates, purge its disposable to avoid unbounded</span></span><br><span class="line">	<span class="comment">// memory growth.</span></span><br><span class="line">	[otherDisposable addDisposable:[RACDisposable disposableWithBlock:^&#123;</span><br><span class="line">		@strongify(otherDisposable);</span><br><span class="line">		[selfDisposable removeDisposable:otherDisposable];</span><br><span class="line">	&#125;]];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>作用就是把整个清除处理操作连成一条线。</p>
<p>回到上一个方法里面，把创建好的<code>RACPassthroughSubscriber</code>实例作为参数调用<code>self.didSubscribe(subscriber)</code>（这里可以看出在订阅的block里面不会有循环引用问题），这个就是创建步骤里面<code>RACDynamicSignal</code>的<code>_didSubscribe</code>变量，也就是<code>createSignal:</code>方法的block。在block里面会调用<code>RACPassthroughSubscriber</code>的<code>sendNext:</code>和<code>sendCompleted</code>方法，它在<code>RACPassthroughSubscriber</code>的实现是：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">```objc</span><br><span class="line">- (<span class="keyword">void</span>)sendNext:(<span class="keyword">id</span>)value &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">self</span>.disposable.disposed) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (RACSIGNAL_NEXT_ENABLED()) &#123;</span><br><span class="line">		RACSIGNAL_NEXT(cleanedSignalDescription(<span class="keyword">self</span>.signal), cleanedDTraceString(<span class="keyword">self</span>.innerSubscriber.description), cleanedDTraceString([value description]));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	[<span class="keyword">self</span>.innerSubscriber sendNext:value];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sendCompleted &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">self</span>.disposable.disposed) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (RACSIGNAL_COMPLETED_ENABLED()) &#123;</span><br><span class="line">		RACSIGNAL_COMPLETED(cleanedSignalDescription(<span class="keyword">self</span>.signal), cleanedDTraceString(<span class="keyword">self</span>.innerSubscriber.description));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	[<span class="keyword">self</span>.innerSubscriber sendCompleted];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里判断信号是否被<code>disposed</code>了，然后调用<code>innerSubscriber</code>（也就是RACSubscriber实例）对应的方法，在<code>RACSubscriber</code>里面。对应的方法实现是：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)sendNext:(<span class="keyword">id</span>)value &#123;</span><br><span class="line">	<span class="keyword">@synchronized</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">		<span class="keyword">void</span> (^nextBlock)(<span class="keyword">id</span>) = [<span class="keyword">self</span>.next <span class="keyword">copy</span>];</span><br><span class="line">		<span class="keyword">if</span> (nextBlock == <span class="literal">nil</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">		nextBlock(value);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sendError:(<span class="built_in">NSError</span> *)e &#123;</span><br><span class="line">	<span class="keyword">@synchronized</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">		<span class="keyword">void</span> (^errorBlock)(<span class="built_in">NSError</span> *) = [<span class="keyword">self</span>.error <span class="keyword">copy</span>];</span><br><span class="line">		[<span class="keyword">self</span>.disposable dispose];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (errorBlock == <span class="literal">nil</span>) <span class="keyword">return</span>;</span><br><span class="line">		errorBlock(e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sendCompleted &#123;</span><br><span class="line">	<span class="keyword">@synchronized</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">		<span class="keyword">void</span> (^completedBlock)(<span class="keyword">void</span>) = [<span class="keyword">self</span>.completed <span class="keyword">copy</span>];</span><br><span class="line">		[<span class="keyword">self</span>.disposable dispose];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (completedBlock == <span class="literal">nil</span>) <span class="keyword">return</span>;</span><br><span class="line">		completedBlock();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里使用了<code>@synchronized</code>以防止在多线程下面，调用dispose以致block next、error、completed被置于nil带来的问题。这里的block就是订阅时对应的block。</p>
<p>在执行完了创建<code>RACSignal</code>里面<code>sendNext:</code>和<code>sendCompleted</code>方法之后，会返回一个RACDisposable,用于订阅被清除时执行的操作，比如用来封装网络请求，在RACDisposable里面就可以执行cancel操作。该RACDisposable会被加入到上层的RACDisposable。</p>
<p>最后<code>- (RACDisposable *)subscribe:(id&lt;RACSubscriber&gt;)subscriber</code>会把<code>self.didSubscribe(subscriber)</code>返回的<code>RACDisposable</code>加入到创建的<code>RACCompoundDisposable</code>实例disposable中去，并返回出去，订阅信号的地方就可以拿到这个<code>RACDisposable</code>，在以后有需要的情况下就可以取消订阅了。</p>
<div class="tip"><br>    <div>1. 在创建信号或者变换信号（调用所有操作方法）的block里面，如果持有了持有信号的对象，就会导致循环引用。</div><br>    <div>2. 订阅的block里面不会引起循环引用。  </div><br></div>
</div></article></div></main><footer><div class="paginator"><a href="/2017/09/24/UIView和CALayer/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">plum</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>