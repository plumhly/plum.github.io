<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> KVO探索与实践 · plum的技术博客</title><meta name="description" content="KVO探索与实践 - plum"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="plum的技术博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/plummit" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/plumhly" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">KVO探索与实践</h1><div class="post-info">2017年4月12日</div><div class="post-content"><h1 id="KVO探索与实践"><a href="#KVO探索与实践" class="headerlink" title="KVO探索与实践"></a>KVO探索与实践</h1><h3 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)addObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath options:(<span class="built_in">NSKeyValueObservingOptions</span>)options context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context</span><br></pre></td></tr></table></figure>
<p>这里有两个需要掌握的知识点：</p>
<h4 id="1-options"><a href="#1-options" class="headerlink" title="1. options"></a><code>1. options</code></h4><ul>
<li>NSKeyValueObservingOptionNew：最新的<code>value</code></li>
<li>NSKeyValueObservingOptionOld：之前的<code>value</code></li>
<li>NSKeyValueObservingOptionInitial: 在注册成观察者之前就会向观察者发送一条同时</li>
<li>NSKeyValueObservingOptionPrior: 在调用<br><code>- (void)willChangeValueForKey:(NSString *)key</code>之前被调用</li>
</ul>
<h4 id="2-context"><a href="#2-context" class="headerlink" title="2. context"></a><code>2. context</code></h4><p>这个参数可以给观察者发送一些数据，多用于区分<code>keyPath</code>，当然是用响应通知的KeyPath也能区分。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *ChangeNameContenxt = &amp;ChangeNameContenxt;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="comment">//way one</span></span><br><span class="line">    <span class="keyword">if</span> ([keyPath isEqualToString:<span class="string">@"name"</span>]) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//or</span></span><br><span class="line">    <span class="comment">//way two</span></span><br><span class="line">    <span class="keyword">if</span> (context == ChangeNameContenxt) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="实践探索"><a href="#实践探索" class="headerlink" title="实践探索"></a>实践探索</h3><h4 id="To-One"><a href="#To-One" class="headerlink" title="To-One"></a>To-One</h4><p><strong>1. 自动发送（Automatic Change Notification）</strong></p>
<p>这里就是一般使用的KVO的场景，省略。<br><br><br><strong>2. 手动发送（ Manual Notification）</strong><br>首先要重写方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversForKey:(<span class="built_in">NSString</span> *)key</span><br></pre></td></tr></table></figure>
<p>根据key判断哪些属性需要手动触发KVO,它还可以用另外一个简单的方法代替：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversOf*Key*</span><br></pre></td></tr></table></figure>
<p>此处的key就是需要手动触发KVO的属性。另外，还需要在setter里面手动触发消息，在赋值之前调用：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)willChangeValueForKey:(<span class="built_in">NSString</span> *)key;</span><br></pre></td></tr></table></figure>
<p>在赋值完成后调用：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)didChangeValueForKey:(<span class="built_in">NSString</span> *)key;</span><br></pre></td></tr></table></figure>
<p><br></p>
<h4 id="To-Many"><a href="#To-Many" class="headerlink" title="To-Many"></a>To-Many</h4><p>了解这个知识点之前，需要知道<code>NSKeyValueChange</code>:</p>
<ul>
<li><code>NSKeyValueChangeSetting</code>: 赋值通知（默认）</li>
<li><code>NSKeyValueChangeInsertion</code>: 插入通知</li>
<li><code>NSKeyValueChangeRemoval</code>: 删除通知</li>
<li><code>NSKeyValueChangeReplacement</code>: 替换通知</li>
</ul>
<p>当需要观察的属性是一个<code>Collection</code>的时候，单纯的观察属性是不在<code>Collection</code>进行<code>添加</code>、<code>删除</code>、<code>替换</code>操作是能获取到通知。所以需手动触发KVO.<br>首先要重写方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversForKey:(<span class="built_in">NSString</span> *)key</span><br><span class="line">或者</span><br><span class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversOf*Key*</span><br></pre></td></tr></table></figure>
<p>然后要在改变之前调用：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)willChange:(<span class="built_in">NSKeyValueChange</span>)changeKind valuesAtIndexes:(<span class="built_in">NSIndexSet</span> *)indexes forKey:(<span class="built_in">NSString</span> *)key;</span><br></pre></td></tr></table></figure>
<p>改变之后调用</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)didChange:(<span class="built_in">NSKeyValueChange</span>)changeKind valuesAtIndexes:(<span class="built_in">NSIndexSet</span> *)indexes forKey:(<span class="built_in">NSString</span> *)key;</span><br></pre></td></tr></table></figure>
<p>这两个接口需要传入一个<code>NSIndexSet</code>对象，来确定进行<code>添加</code>、<code>删除</code>、<code>替换</code>操作的位置。<br><br></p>
<h4 id="相互影响的属性"><a href="#相互影响的属性" class="headerlink" title="相互影响的属性"></a>相互影响的属性</h4><p>有些情况下，除了改变被观察的属性发生变化要发通知之外，修改某一属性的值也可能影响到被观察的属性，也要触发KVO通知。<br>对于这种情况，需要重写：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSSet</span>&lt;<span class="built_in">NSString</span> *&gt; *)keyPathsForValuesAffectingValueForKey:(<span class="built_in">NSString</span> *)key</span><br><span class="line"> 或者</span><br><span class="line"> + (<span class="built_in">NSSet</span>&lt;<span class="built_in">NSString</span> *&gt; *)keyPathsForValuesAffecting*Key*</span><br></pre></td></tr></table></figure>
<p>把相关的属性通过<code>NSSet</code>返回。除此之外，还需要重写被观察属性的<code>getter</code>方法，表明被观察属性和影响属性的关系<strong>（如果不写：那么接收KVO的方法返回的值就不会和影响属性有关系）</strong>。<br>例如，姓名由姓和名组成，那么改变姓或者名，那么这个姓名就会发生变化。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .h</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *fullName;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *firstName;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *lastName;</span><br><span class="line"></span><br><span class="line"><span class="comment">// .m</span></span><br><span class="line">+ (<span class="built_in">NSSet</span>&lt;<span class="built_in">NSString</span> *&gt; *)keyPathsForValuesAffectingFullName &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSSet</span> setWithObjects:<span class="string">@"firstName"</span>, <span class="string">@"lastName"</span>, <span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)fullName &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@-%@"</span>, _firstName, _lastName];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在观察的接受方法中：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)object change:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>, <span class="keyword">id</span>&gt; *)change context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context</span><br></pre></td></tr></table></figure>
<p>就会接收到<code>fullName</code>改变的通知</p>
<p><br></p>
<h4 id="深层嵌套属性"><a href="#深层嵌套属性" class="headerlink" title="深层嵌套属性"></a>深层嵌套属性</h4><blockquote>
<p>假象一种场景：一个部门有一些工作者，当他们的工资发生变化是，统计部门的总工资也要变化。解决这一问题有两种方法；</p>
</blockquote>
<p><strong><em>解决方法一：</em></strong> 先分析，这里有两个模型 <code>Department</code>、<code>Employee</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Department.h</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> &lt;Employee *&gt; *employees;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> totalSalary;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// Employee.h</span><br><span class="line">@property (nonatomic, assign) NSInteger salary;</span><br></pre></td></tr></table></figure>
<p>在初始化<code>Department</code>时，把<code>Department</code>注册成为<code>Employee</code>的观察者。<br>例如：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Department.m (init)</span></span><br><span class="line"> - (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">//array</span></span><br><span class="line">        <span class="built_in">NSMutableArray</span> *array = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            Employee *employe = [Employee new];</span><br><span class="line">            employe.salary = i;</span><br><span class="line">            [employe addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"salary"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> context:<span class="literal">nil</span>];</span><br><span class="line">            [array addObject:employe];</span><br><span class="line">        &#125;</span><br><span class="line">        _employees = [array <span class="keyword">copy</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在接收KVO通知方法里面：</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    [<span class="keyword">self</span> setTotalSalary:[[<span class="keyword">self</span> valueForKeyPath:<span class="string">@"employees.@sum.salary"</span>] integerValue]];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样观察<code>Department</code>的<code>totalSalary</code>属性就可以观察到变化了。</p>
<p><strong><em>解决方法二：</em></strong>使用<code>CoreData</code>来实现。<br><br></p>
<h3 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h3><p>正如苹果官方文档里面的描述：</p>
<blockquote>
<p>Automatic key-value observing is implemented using a technique called isa-swizzling.</p>
<p>The isa pointer, as the name suggests, points to the object’s class which maintains a dispatch table. This dispatch table essentially contains pointers to the methods the class implements, among other data.</p>
<p>When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class. As a result the value of the isa pointer does not necessarily reflect the actual class of the instance.</p>
<p>You should never rely on the isa pointer to determine class membership. Instead, you should use the class method to determine the class of an object instance.</p>
</blockquote>
<p>当某一属性被观察时，会生成一个中间类<strong>（NSKVONotifying_原类名）</strong>，改中间类会做一下处理</p>
<ul>
<li>重写<code>setter</code>，手动发送KVO通知。</li>
<li>重写<code>class</code>方法，隐藏真实类名，不过可以用<code>object_getClass()</code>获取。</li>
<li>添加方法<code>- (BOOL)_isKVOA</code>判断被动态生成KVO子类</li>
</ul>
<p><br></p>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><div class="tip"><br>    <div>1. 在被观察对象释放的时候需要移除KVO</div><br>    <div>2. 一个需要注意的地方是，KVO 行为是同步的，并且发生与所观察的值发生变化的同样的线程上。</div><br></div>

<p><br></p>
<h6 id="资料参考："><a href="#资料参考：" class="headerlink" title="资料参考："></a>资料参考：</h6><ul>
<li><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html#//apple_ref/doc/uid/10000177-BCICJDHA" target="_blank" rel="noopener">Key-Value Observing Programming Guide</a></li>
<li><a href="http://blog.sunnyxx.com/2014/03/09/objc_kvo_secret/" target="_blank" rel="noopener">objc kvo简单探索</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2017/05/23/KVC探索与实践/" class="prev">上一篇</a><a href="/2017/03/22/字节序/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">plum</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>